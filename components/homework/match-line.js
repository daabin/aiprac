/* eslint-disable */
class t{container;items;itemActiveCls;canvas;ctx;backCtx;strokeStyle;lineWidth;trigger=!1;startPoint={x:0,y:0};startElement=null;endElement=null;backLines=[];answers;standardAnswers;correctlineColor;mislineColor;disabled;debug;tag;onChange;constructor(t){const{container:e,canvas:s,backCanvas:i,items:a,itemActiveCls:h="active",strokeStyle:n="#6495ED",lineWidth:c=1,answers:r,standardAnswers:o,checkAnswers:l=!1,correctlineColor:d="#3CB371",mislineColor:m="#DC143C",disabled:g=!1,debug:k=!1,onChange:u}=t;this.tag="v__"+Math.random().toString(36).slice(2),this.container=e,this.items=a,this.itemActiveCls=h,this.answers=r||{},this.standardAnswers=o,this.correctlineColor=d,this.mislineColor=m,this.disabled=g,this.debug=k,this.onChange=u,this.canvas=s,this.ctx=s.getContext("2d"),this.backCtx=i.getContext("2d"),this.strokeStyle=n,this.lineWidth=c;const{width:v,height:C}=e.getBoundingClientRect();s.width=i.width=v,s.height=i.height=C,this.debug&&console.log("[MatchLine]：初始化成功"),this.convertItems(a),a.forEach((t=>t.onmousedown=this.mousedown.bind(this))),e.onmousemove=this.mousemove.bind(this),e.onmouseup=this.mouseup.bind(this),e.onmouseleave=this.mouseleave.bind(this),l&&r&&o?this.checkAnswers():r&&this.echoAnswers()}calcRect(t){const{width:e,height:s}=t.getBoundingClientRect();let i=t.offsetParent;const a={top:t.offsetTop,left:t.offsetLeft,width:e,height:s};for(;i;)a.top+=i.offsetTop,a.left+=i.offsetLeft,i=i.offsetParent;return a}convertItems(t){const{left:e,top:s}=this.calcRect(this.canvas);t.forEach((t=>{t.classList.remove(this.itemActiveCls);const i=t.dataset.ownership,{left:a,top:h,width:n,height:c}=this.calcRect(t),r=a-e+("L"===i?n:0),o=h-s+c/2;t.dataset.anchorX=String(r),t.dataset.anchorY=String(o),t.dataset.checked="0",t.dataset.tag=this.tag,this.debug&&(this.ctx?.beginPath(),this.ctx?.stroke(),this.ctx?.closePath())})),this.debug&&console.log("[MatchLien]：元素锚点信息已挂载")}mousedown(t){if(this.disabled)return;const e=t.currentTarget;e.classList.add(this.itemActiveCls),this.startElement=e,this.startPoint.x=+e.dataset.anchorX,this.startPoint.y=+e.dataset.anchorY,this.trigger=!0}mousemove(t){if(!this.trigger||!this.ctx)return;const{clientX:e,clientY:s}=t,{left:i,top:a}=this.canvas.getBoundingClientRect(),h={x:e-i,y:s-a};this.ctx.strokeStyle=this.strokeStyle,this.ctx.lineWidth=this.lineWidth,this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.beginPath(),this.ctx.moveTo(this.startPoint.x,this.startPoint.y),this.ctx.lineTo(h.x,h.y),this.ctx.closePath(),this.ctx.stroke();const n=document.elementFromPoint(e,s),c=this.startElement?.dataset.ownership;if(n===this.endElement)return;const r=n?.dataset.tag===this.tag,o=n?.dataset.ownership!==c,l="1"!==n?.dataset.checked;r&&o&&l?(this.endElement=n,this.endElement.classList.add(this.itemActiveCls),this.endElement.dataset.checked="1",this.startElement.dataset.checked="1"):this.endElement&&(this.endElement.classList.remove(this.itemActiveCls),this.endElement.dataset.checked=this.startElement.dataset.checked="0",this.endElement=null)}mouseup(){if(this.trigger){if(this.startElement&&"1"!==this.startElement.dataset.checked&&this.startElement.classList.remove(this.itemActiveCls),this.startElement&&this.endElement&&"1"===this.startElement.dataset.checked&&"1"===this.endElement.dataset.checked){const{anchorX:t,anchorY:e}=this.startElement.dataset,{anchorX:s,anchorY:i}=this.endElement.dataset,a=this.startElement.dataset.ownership,h=this.startElement.dataset.value,n=this.endElement.dataset.value,c=Object.keys(this.answers),r=Object.values(this.answers);if(c.includes(h)||r.includes(h)){let t="",e="";for(let s=0;s<c.length;s++){const i=c[s],a=r[s];if([i,a].includes(h)){t=i,e=i===h?a:i;break}}const s=`[data-value="${e}"]`,i=this.container.querySelector(s);if(!i)return;i.dataset.checked="0",i.classList.remove(this.itemActiveCls),delete this.answers[t];const a=this.backLines.findIndex((e=>e.key===t));a>=0&&this.backLines.splice(a,1)}const o="L"===a?h:n,l="L"===a?n:h;this.answers[o]=l,this.onChange&&this.onChange({...this.answers}),this.backLines.push({key:o,point:{x1:+(t||0),y1:+(e||0),x2:+(s||0),y2:+(i||0)}}),this.drawLines()}this.trigger=!1,this.startElement=null,this.endElement=null,this.ctx?.clearRect(0,0,this.canvas.width,this.canvas.height)}}mouseleave(){this.trigger&&this.startElement&&(this.startElement.classList.remove(this.itemActiveCls),this.ctx?.clearRect(0,0,this.canvas.width,this.canvas.height),this.startElement=null,this.trigger=!1)}drawLines(){this.backCtx&&(this.backCtx.clearRect(0,0,this.canvas.width,this.canvas.height),this.backCtx.strokeStyle=this.strokeStyle,this.backCtx.lineWidth=this.lineWidth,this.backLines.map((({point:{x1:t,x2:e,y1:s,y2:i}})=>{this.backCtx?.beginPath(),this.backCtx?.moveTo(t,s),this.backCtx?.lineTo(e,i),this.backCtx?.closePath(),this.backCtx?.stroke()})))}echoAnswers(){Object.keys(this.answers).forEach((t=>{if(this.answers.hasOwnProperty(t)){const e=`[data-value="${t}"]`,s=`[data-value="${this.answers[t]}"]`,i=this.container.querySelector(e),a=this.container.querySelector(s);if(i&&a){i.dataset.checked=a.dataset.checked="1",i.classList.add("active"),a.classList.add("active");const{anchorX:e,anchorY:s}=i.dataset,{anchorX:h,anchorY:n}=a.dataset;this.backLines.push({key:t,point:{x1:+(e||0),y1:+(s||0),x2:+(h||0),y2:+(n||0)}})}}})),this.drawLines()}reset(){this.backCtx?.clearRect(0,0,this.canvas.width,this.canvas.height),this.items.forEach((t=>{t.classList.remove(this.itemActiveCls),t.dataset.checked="0"})),this.answers={},this.backLines=[],this.onChange&&this.onChange({...this.answers})}undo(){const t=this.backLines.pop();if(t){const{key:e}=t,s=`[data-value="${e}"]`,i=`[data-value="${this.answers[e]}"]`;delete this.answers[e];const a=this.container.querySelector(s),h=this.container.querySelector(i);a&&h&&(a.dataset.checked=h.dataset.checked="0",a.classList.remove(this.itemActiveCls),h.classList.remove(this.itemActiveCls),this.drawLines()),this.onChange&&this.onChange({...this.answers})}else this.debug&&console.log("[MatchLine]：当前无可撤销的记录")}getAnswers(){return{...this.answers}}checkAnswers(){const t=Object.keys(this.answers);if(!this.standardAnswers||!this.backCtx||0===t.length)return;const e=[];t.forEach((t=>{if(this.answers.hasOwnProperty(t)){const s=this.answers[t],i=`[data-value="${t}"]`,a=`[data-value="${s}"]`,h=this.container.querySelector(i),n=this.container.querySelector(a);if(h&&n){h.dataset.checked=n.dataset.checked="1",h.classList.add(this.itemActiveCls),n.classList.add(this.itemActiveCls);const{anchorX:i,anchorY:a}=h.dataset,{anchorX:c,anchorY:r}=n.dataset,o=this.standardAnswers[t];e.push({isOk:s===o,point:{x1:+(i||0),y1:+(a||0),x2:+(c||0),y2:+(r||0)}})}}})),this.backCtx.clearRect(0,0,this.canvas.width,this.canvas.height),e.forEach((({isOk:t,point:{x1:e,y1:s,x2:i,y2:a}})=>{this.backCtx.strokeStyle=t?this.correctlineColor:this.mislineColor,this.backCtx.beginPath(),this.backCtx.moveTo(e,s),this.backCtx.lineTo(i,a),this.backCtx.stroke()}))}}export{t as default};
